steps:
  - name: 'gcr.io/cloud-builders/docker'
    id: 'create-builder'
    waitFor: ['-']
    args: ['buildx', 'create', '--driver', 'docker-container', '--name', 'container', '--use']

  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-image'
    waitFor: ['create-builder']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -euxo pipefail
        # Extract version from tag 
        VERSION=${TAG_NAME}
        
        # Build and push with version tags
        docker buildx build \
            --push \
            --platform linux/amd64,linux/arm64 \
            -t $LOCATION-docker.pkg.dev/$PROJECT_ID/uptime-checker/image:$VERSION \
            -t $LOCATION-docker.pkg.dev/$PROJECT_ID/uptime-checker/image:latest \
            --label org.opencontainers.image.revision=$COMMIT_SHA \
            --label org.opencontainers.image.version=$VERSION \
            --label org.opencontainers.image.title=uptime-checker \
            --label org.opencontainers.vendor="Sentry" \
            --label org.opencontainers.image.title="Sentry Uptime Checker Service" \
            --label org.opencontainers.image.source=$REPO_FULL_NAME \
            --label org.opencontainers.image.url=$REPO_FULL_NAME \
            --cache-from $LOCATION-docker.pkg.dev/$PROJECT_ID/uptime-checker/image:$COMMIT_SHA \
            --sbom true \
            --provenance="mode=max" \
            --build-arg UPTIME_CHECKER_GIT_REVISION=$COMMIT_SHA \
            .

options:
  machineType: 'E2_HIGHCPU_32'
  diskSizeGb: 100
